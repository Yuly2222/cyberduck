<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyberduck</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&family=Oxanium:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles/main.css">
</head>

<body>
  <!-- HEADER -->
  <header class="header">
    <div class="container header__inner">
      <div class="brand">
        <a class="brand__logo-group" href="./index.html">
          <img src="./imgs/logo.png" alt="Cyberduck logo" class="brand__img">
          <div class="brand__logo">CYBERDUCK</div>
        </a>
        <nav class="nav" aria-label="navegación principal">
          <a class="nav__link" href="./nuevo.html">¿qué hay de nuevo?</a>
          <div class="nav__item nav__item--dropdown">
            <a class="nav__link nav__link--parent" href="./ropa.html?cat=todos" aria-haspopup="true">ropa <span class="nav__chevron" aria-hidden="true"></span></a>
            <div class="nav__dropdown" role="menu">
              <a class="nav__dropdown-link" href="./ropa.html?cat=todos" role="menuitem">Todo</a>
              <a class="nav__dropdown-link" href="./ropa.html?cat=camisetas" role="menuitem">Camisetas</a>
              <a class="nav__dropdown-link" href="./ropa.html?cat=faldas" role="menuitem">Faldas</a>
            </div>
          </div>
          <a class="nav__link" href="./accesorios.html">accesorios</a>
          <div class="nav__item nav__item--dropdown">
            <a class="nav__link nav__link--parent" href="./impresion3d.html?cat=todos" aria-haspopup="true">impresión 3D <span class="nav__chevron" aria-hidden="true"></span></a>
            <div class="nav__dropdown" role="menu">
              <a class="nav__dropdown-link" href="./impresion3d.html?cat=llaveros" role="menuitem">Llaveros</a>
              <a class="nav__dropdown-link" href="./impresion3d.html?cat=figuras" role="menuitem">Figuras</a>
              <a class="nav__dropdown-link" href="./impresion3d.html?cat=coleccion" role="menuitem">Colección</a>
            </div>
          </div>
          <a class="nav__link" href="./media.html">media</a>
          <a class="nav__link" href="./nosotros.html">nosotros</a>
          <a class="nav__custom" href="./personalizar.html">✨ personaliza tu 3D ✨</a>
        </nav>
      </div>

      <div class="header__actions">
        <a class="pill pill--neon" href="./index.html#login">iniciar sesión</a>
        <button class="iconbtn" type="button" aria-label="Idioma">ES</button>
        <button class="iconbtn" type="button" aria-label="Buscar">⌕</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="section section--impresion3d">
        <div class="section__head">
          <h1 class="section__title" id="impresion3dTitle">Impresión 3D</h1>
          <a class="viewall" href="./index.html">volver al inicio</a>
        </div>

        <div class="filter-tabs" id="filterTabs">
          <button class="filter-tab" data-cat="todos">Todo</button>
          <button class="filter-tab" data-cat="llaveros">Llaveros</button>
          <button class="filter-tab" data-cat="figuras">Figuras</button>
          <button class="filter-tab" data-cat="coleccion">Colección</button>
        </div>

        <div style="margin:18px 0;">
          <a class="viewall" href="./personalizar.html">Personaliza tu 3D →</a>
        </div>

        <div class="gallery" id="impresion3dGallery">
          <!-- Gallery items are loaded dynamically from Google Sheets -->
        </div>
      </section>
    </div>
  </main>

  <script>
    // Obtener parámetro cat de URL
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('cat') || 'todos';
    
    // Actualizar título
    const titleEl = document.getElementById('impresion3dTitle');
    if (category === 'llaveros') {
      titleEl.textContent = 'Impresión 3D — Llaveros';
    } else if (category === 'figuras') {
      titleEl.textContent = 'Impresión 3D — Figuras';
    } else if (category === 'coleccion') {
      titleEl.textContent = 'Impresión 3D — Colección';
    } else {
      titleEl.textContent = 'Impresión 3D — Todo';
    }

    // Filtrar productos
    const items = document.querySelectorAll('.gallery__item');
    items.forEach(item => {
      const itemCat = item.getAttribute('data-category');
      if (category === 'todos' || category === itemCat) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });

    // Marcar tab activo
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
      const tabCat = tab.getAttribute('data-cat');
      if (tabCat === category) {
        tab.classList.add('is-active');
      } else {
        tab.classList.remove('is-active');
      }
      
      // Click handler para cambiar filtro
      tab.addEventListener('click', () => {
        window.location.href = `./impresion3d.html?cat=${tabCat}`;
      });
    });

    // Función para asignar comportamiento de click a los productos
    function setupProductClickHandlers() {
      const printItems = document.querySelectorAll('.gallery__item');
      printItems.forEach(item => {
        item.style.cursor = 'pointer';
        // Evitar múltiples listeners
        item.replaceWith(item.cloneNode(true));
      });

      // Re-seleccionar después del replace
      const newItems = document.querySelectorAll('.gallery__item');
      newItems.forEach(item => {
        item.addEventListener('click', () => {
          const name = item.querySelector('.gallery__name')?.textContent || 'Producto';
          const price = item.querySelector('.gallery__price')?.textContent || '';
          const category = item.getAttribute('data-category') || '';
          const imgDiv = item.querySelector('.gallery__image');
          let image = '';
          if (imgDiv) {
            const bg = getComputedStyle(imgDiv).backgroundImage;
            image = (bg && bg !== 'none') ? bg : '';
          }

          const desc = item.querySelector('.gallery__desc')?.textContent || '';
          const prod = { name, price, category, image, desc };
          localStorage.setItem('cyberduck:selectedProduct', JSON.stringify(prod));
          window.location.href = './product.html';
        });
      });
    }

    

    // === Integración con Google Sheets ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLTeWyAHgR_0i2bE50o-ufvp0gK_FnNcVaMc_S80xpSW-6MHQgTLoxm-6eeYeWz6hE/exec';

    // Renderiza items recibidos desde el script
    function renderItemsFromSheet(rows) {
      const gallery = document.getElementById('impresion3dGallery');
      if (!rows || !rows.length) return;

      // Limpiar contenido actual
      gallery.innerHTML = '';

      rows.forEach(row => {
        // Normalizar claves (trim + lowercase) para aceptar variantes como NAME, Name, name
        const normalized = {};
        Object.keys(row).forEach(k => {
          if (!k) return;
          normalized[k.trim().toLowerCase()] = row[k];
        });

        const name = normalized['name'] || normalized['nombre'] || normalized['producto'] || normalized['title'] || 'Producto';
        const price = normalized['price'] || normalized['precio'] || '';
        const category = (normalized['category'] || normalized['categoria'] || '').toString().toLowerCase();
        const image = normalized['image'] || normalized['imagen'] || normalized['img'] || '';
        const desc = normalized['desc'] || normalized['descripcion'] || normalized['description'] || '';

        const article = document.createElement('article');
        article.className = 'gallery__item';
        if (category) article.setAttribute('data-category', category);

        article.innerHTML = `
          <div class="gallery__image" style="background-image: url('${image}');"></div>
          <div class="gallery__meta">
            <p class="gallery__name">${name}</p>
            <p class="gallery__price">${price}</p>
            <p class="gallery__category">${category ? category.charAt(0).toUpperCase() + category.slice(1) : ''}</p>
            <p class="gallery__desc" style="display:none">${desc}</p>
          </div>
        `;

        gallery.appendChild(article);
      });

      // aplicar filtros según la categoría actual
      const items = document.querySelectorAll('.gallery__item');
      items.forEach(item => {
        const itemCat = item.getAttribute('data-category');
        if (category === 'todos' || category === itemCat) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });

      setupProductClickHandlers();
    }

    // Fetch GET desde el script para obtener los datos
    fetch(SCRIPT_URL)
      .then(r => r.json())
      .then(json => {
        if (json && Array.isArray(json.data) && json.data.length) {
          renderItemsFromSheet(json.data);
        }
      })
      .catch(err => {
        console.warn('No se pudo obtener datos desde Google Sheets:', err);
      });

    // Formulario simple para enviar nuevos registros via POST
    (function setupSheetForm() {
      const container = document.createElement('div');
      container.style.margin = '24px 0';
      container.innerHTML = `
        <details>
          <summary style="cursor:pointer;">Enviar nuevo item a Google Sheets (admin)</summary>
          <form id="sheetForm" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <input name="name" placeholder="Nombre" style="flex:1;min-width:160px" required>
            <input name="price" placeholder="Precio" style="min-width:120px">
            <input name="category" placeholder="Categoría" style="min-width:120px">
            <input name="image" placeholder="URL imagen" style="flex:1;min-width:160px">
            <input name="desc" placeholder="Descripción" style="flex-basis:100%">
            <button type="submit">Enviar</button>
          </form>
          <div id="sheetFormMsg" style="margin-top:8px"></div>
        </details>
      `;

      const section = document.querySelector('.section--impresion3d .container') || document.querySelector('.container');
      // Insertar después de la galería
      const gallery = document.getElementById('impresion3dGallery');
      gallery.parentNode.insertBefore(container, gallery.nextSibling);

      const form = document.getElementById('sheetForm');
      const msg = document.getElementById('sheetFormMsg');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          name: fd.get('name'),
          price: fd.get('price'),
          category: fd.get('category'),
          image: fd.get('image'),
          desc: fd.get('desc')
        };

        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(j => {
          if (j && j.ok) {
            msg.textContent = 'Enviado correctamente. Refresca para ver el cambio.';
            form.reset();
          } else {
            msg.textContent = 'Error al enviar.';
          }
        })
        .catch(err => {
          msg.textContent = 'Error de red: ' + err.message;
        });
      });
    })();

    // Inicializar handlers para los productos estáticos iniciales
    setupProductClickHandlers();
  </script>
  <script src="./scripts/main.js"></script>
</body>
</html>
